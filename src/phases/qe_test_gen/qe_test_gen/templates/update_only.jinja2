{% macro ingest(x) %}{% include x %}{% endmacro %}
SchemaVersion: 2018-07-01
Owner: "@10gen/server-security"
Description: |
  Performs a series of insert operations, using the following properties:
    - All documents have 11 fields, including 1 _id field, and 10 data fields.
    - The first <<encryptedFields>> data fields are encrypted.
    - _id is always unique.
    - Values in data fields fit a '<<collectionName>>' distribution.
    - The insertions are performed by <<threadCount>> client threads.
  This test is uniquely identified as '<<testName>>'.

{% if encryptedFields %}
Encryption:
  UseCryptSharedLib: true
  CryptSharedLibPath: /data/workdir/mongocrypt/lib/mongo_crypt_v1.so
  EncryptedCollections:
  - Database: genny_qebench2
    Collection: <<collectionName>>
    EncryptionType: queryable

QueryableEncryptedFields:
  field0: &field_schema { type: "string", queries: [{queryType: "equality", contention: <<contentionFactor>> }}] }
{% for num in range(1, encryptedFields) %}
  field<<num>>: *field_schema
{% endfor %}
{% endif %}

Clients:
  EncryptedPool:
    QueryOptions:
      maxPoolSize: 400
{% if encryptedFields %}
    EncryptionOptions:
      KeyVaultDatabase: "keyvault"
      KeyVaultCollection: "datakeys"
      EncryptedCollections:
      - genny_qebench2.<<collectionName>>
{% endif %}


Actors:
  - Name: InsertActor
    Type: CrudActor
    Threads: <<threadCount>>
    Database: genny_qebench2
    ClientName: EncryptedPool
    Phases:
    {% for phase in phases %}
    << ingest(phase) | indent >>
    {% endfor %}
  
  - Name: LoggingActor0
    Type: LoggingActor
    Threads: 1
    Phases:
      - Phase: 0..<<maxPhase>>
        LogEvery: 5 minutes
        Blocking: None

{% if shouldAutoRun %}
AutoRun:
- When:
    mongodb_setup:
      $eq:
      - single-replica-fle
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v6.0
      - v6.1
      - v6.2
{% endif %}